<html>
    <head>
        <link rel="stylesheet" type="text/css" href="SpeedySundaes.css">
    </head>
    <body>
        <table>
            <tr>
                <td>
        <table>
            <tr><td colspan="5"><span class="board">
                <table id="boardTable">
                    <tr>
                        <td id='boardTableSpace0' class="boardTableSpace" boardColor="lightBlue"></td>
                        <td id='boardTableSpace1' class="boardTableSpace" boardColor="darkBlue"></td>
                        <td id='boardTableSpace2' class="boardTableSpace" boardColor="lightBlue"></td>
                        <td id='boardTableSpace3' class="boardTableSpace" boardColor="darkBlue"></td>
                        <td id='boardTableSpace4' class="boardTableSpace" boardColor="darkPink"></td>
                        <td id='boardTableSpace5' class="boardTableSpace" boardColor="lightPink"></td>
                        <td id='boardTableSpace6' class="boardTableSpace" boardColor="darkPink"></td>
                        <td id='boardTableSpace7' class="boardTableSpace" boardColor="lightPink"></td>
                    </tr>
                    <tr>
                        <td id='boardTableSpace17' class="boardTableSpace" boardColor="darkBlue"></td>
                        <td colspan=6 class="boardTableSpace"></td>
                        <td id='boardTableSpace8' class="boardTableSpace" boardColor="darkPink"></td>
                    </tr>
                    <tr>
                        <td id='boardTableSpace16' class="boardTableSpace" boardColor="lightBlue"></td>
                        <td id='boardTableSpace15' class="boardTableSpace" boardColor="darkBlue"></td>
                        <td id='boardTableSpace14' class="boardTableSpace" boardColor="lightBlue"></td>
                        <td id='boardTableSpace13' class="boardTableSpace" boardColor="darkBlue"></td>
                        <td id='boardTableSpace12' class="boardTableSpace" boardColor="darkPink"></td>
                        <td id='boardTableSpace11' class="boardTableSpace" boardColor="lightPink"></td>
                        <td id='boardTableSpace10' class="boardTableSpace" boardColor="darkPink"></td>
                        <td id='boardTableSpace9' class="boardTableSpace" boardColor="lightPink"></td>
                    </tr>
                </table>
            </span></td></tr>
            <tr style="height:40px"></tr>
            <tr><td id='lightPinkDeck' class="cardSlotLightPink cardSlot lightPink" onclick="javascript:pickCard(this,lightPinkDeck);"><img id='lightPinkDeckCard' class='card'><br><span id='lightPinkDeckText'>&nbsp;</span></td>
                <td id='darkPinkDeck' class="cardSlotDarkPink cardSlot darkPink" onclick="javascript:pickCard(this,darkPinkDeck);"><img id='darkPinkDeckCard' class='card'><br><span id='darkPinkDeckText'>&nbsp;</span></td>
                <td id='lightBlueDeck' class="cardSlotLightBlue cardSlot lightBlue" onclick="javascript:pickCard(this,lightBlueDeck);"><img id='lightBlueDeckCard' class='card'><br><span id='lightBlueDeckText'>&nbsp;</span></td>
                <td id='darkBlueDeck' class="cardSlotDarkBlue cardSlot darkBlue" onclick="javascript:pickCard(this,darkBlueDeck);"><img id='darkBlueDeckCard' class='card'><br><span id='darkBlueDeckText'>&nbsp;</span></td>
                <td id='spinner' class="spinnerSlot" onclick="javascript:moveNextPlayer(this);"><span class="spinner"><img id='spinnerWheel' style='display:none' class='spinnerArrow rotate' src='assets/arrow.png'></span><br><span id='spinnerText'>&nbsp;</span></td>
        </table>
        </td>
        <td class="playerInfo">
            <table>
                <tr><td><img id='playerAvatar' class='card'></td></tr>
                <tr><td id='playerIngredients' class="playerIngredients"></td></tr>
            </table>

        </td>
        </tr>
        </table>
        <script>
            // Game configuration
            const config = {
                                players : [ 
                                                { name : "Peach", image : "assets/avatarPeach.png" },
                                                { name : "Lemon", image : "assets/avatarLemon.png" },
                                                { name : "Cereal", image : "assets/avatarCereal.png" },
                                                { name : "Cherry", image : "assets/avatarCherry.png" }
                                        ],
                                cards : [ 
                                                { type : "Ingredient", color : "darkBlue", name : "Cream", points : 3, image : "assets/darkBlueCream.png" },
                                                { type : "Ingredient", color : "darkBlue", name : "Sugar", points : 1, image : "assets/darkBlueSugar.png" },
                                                { type : "Ingredient", color : "darkBlue", name : "Vanilla", points : 3, image : "assets/darkBlueVanilla.png" },

                                                { type : "Ingredient", color : "darkPink", name : "Cocoa", points : 4, image : "assets/darkPinkCocoa.png" },
                                                { type : "Ingredient", color : "darkPink", name : "Strawberry", points : 4, image : "assets/darkPinkStrawberry.png" },
                                                { type : "Ingredient", color : "darkPink", name : "Sugar", points : 1, image : "assets/darkPinkSugar.png" },

                                                { type : "Ingredient", color : "lightBlue", name : "Cream", points : 3, image : "assets/lightBlueCream.png" },
                                                { type : "Ingredient", color : "lightBlue", name : "Sugar", points : 1, image : "assets/lightBlueSugar.png" },
                                                { type : "Ingredient", color : "lightBlue", name : "Vanilla", points : 3, image : "assets/lightBlueVanilla.png" },
                                                { type : "PowerUp", color : "lightBlue", name : "CandyCraving", points : 0, image : "assets/lightBlueCandyCraving.png", extraCards : 2 },
                                                { type : "PowerUp", color : "lightBlue", name : "GroceryMixup", points : 0, image : "assets/lightBlueGroceryMixup.png" },
                                                { type : "PowerUp", color : "lightBlue", name : "PickyEater", points : 0, image : "assets/lightBluePickyEater.png", extraCards : 1 },
                                                { type : "PowerUp", color : "lightBlue", name : "SugarRush", points : 0, image : "assets/lightBlueSugarRush.png", extraTurns : 1 },

                                                { type : "Ingredient", color : "lightPink", name : "Butter", points : 3, image : "assets/lightPinkButter.png" },
                                                { type : "Ingredient", color : "lightPink", name : "Cocoa", points : 4, image : "assets/lightPinkCocoa.png" },
                                                { type : "Ingredient", color : "lightPink", name : "Egg", points : 3, image : "assets/lightPinkEgg.png" },
                                                { type : "Ingredient", color : "lightPink", name : "Strawberry", points : 4, image : "assets/lightPinkStrawberry.png" },
                                                { type : "Ingredient", color : "lightPink", name : "Sugar", points : 1, image : "assets/lightPinkSugar.png" },

                                                { type : "Food", name : "IceCream", points : 20, image : "assets/purpleIceCream.png",
                                                    ingredients : [ 
                                                                    { count : 2, name : "Sugar" }, 
                                                                    { count : 2, name : "Cream" },
                                                                    { count : 1, name : "Vanilla" },
                                                                    { count : 1, name : "Egg" }
                                                                ] },
                                                { type : "Food", name : "WhippedCream", points : 10, image : "assets/purpleWhippedCream.png",
                                                    ingredients : [ 
                                                                    { count : 1, name : "Sugar" },
                                                                    { count : 2, name : "Cream" } 
                                                                ] },
                                                { type : "Food", name : "StrawberrySauce", points : 15, image : "assets/strawberrySauce.png",
                                                    ingredients : [ 
                                                                    { count : 2, name : "Strawberry" },
                                                                    { count : 2, name : "Sugar" }
                                                                ] },
                                                { type : "Food", name : "ChocolateSauce", points : 20, image : "assets/purpleChocolateSauce.png",
                                                    ingredients : [ 
                                                                    { count : 3, name : "Sugar" },
                                                                    { count : 1, name : "Cream" },
                                                                    { count : 2, name : "Cocoa" }
                                                                ] },
                                                { type : "Food", name : "CaramelSauce", points : 15, image : "assets/purpleCaramelSauce.png",
                                                    ingredients : [ 
                                                                    { count : 4, name : "Sugar" },
                                                                    { count : 1, name : "Cream" },
                                                                    { count : 1, name : "Vanilla" },
                                                                    { count : 1, name : "Butter" }
                                                                ] },
                                                { type : "Food", name : "Cones", points: 10, image : "assets/purpleCones.png",
                                                    ingredients : [ 
                                                                    { count : 1, name : "Sugar" },
                                                                    { count : 2, name : "Egg" },
                                                                    { count : 1, name : "Butter" },
                                                                    { count : 2, name : "Flour" }
                                                                ] },
                                                { type : "Food", name : "Sprinkles", points: 10, image : "assets/purpleSprinkles.png",
                                                    ingredients : [ 
                                                                    { count : 3, name : "Sugar" },
                                                                    { count : 1, name : "Vanilla" },
                                                                    { count : 1, name : "Egg" }
                                                                ] }
                                        ],
                                lightPinkDeck : [ 
                                                { count : 40, name : "Sugar" },
                                                { count : 10, name : "Strawberry" },
                                                { count : 10, name : "Egg" },
                                                { count : 10, name : "Cocoa" },
                                                { count : 10, name : "Butter" }
                                        ],
                                darkPinkDeck : [ 
                                                { count : 40, name : "Sugar" },
                                                { count : 20, name : "Strawberry" },
                                                { count : 20, name : "Cocoa" }
                                        ],
                                lightBlueDeck : [ 
                                                { count : 40, name : "Sugar" },
                                                { count : 10, name : "Cream" },
                                                { count : 10, name : "Vanilla" },
                                                { count : 4, name : "CandyCraving" },
                                                { count : 6, name : "GroceryMixup" },
                                                { count : 6, name : "PickyEater" },
                                                { count : 4, name : "SugarRush" },
                                        ],
                                darkBlueDeck : [ 
                                                { count : 40, name : "Sugar" },
                                                { count : 20, name : "Cream" },
                                                { count : 20, name : "Vanilla" }
                                        ]
                            }   
            console.log(config);

            // Add cards to Light Pink deck
            let lightPinkDeck = [];
            for ( i=0; i<config.lightPinkDeck.length; i++ ) {
                for ( j=0; j<config.lightPinkDeck[i].count; j++ ) {
                    card = config.cards.find(cards => cards.color === 'lightPink' && cards.name === config.lightPinkDeck[i].name);
                    card.count = 1;
                    lightPinkDeck.push(card);
                } // for
            } // for

            // Add cards to Dark Pink deck
            let darkPinkDeck = [];
            for ( i=0; i<config.darkPinkDeck.length; i++ ) {
                for ( j=0; j<config.darkPinkDeck[i].count; j++ ) {
                    card = config.cards.find(cards => cards.color === 'darkPink' && cards.name === config.darkPinkDeck[i].name);
                    card.count = 1;
                    darkPinkDeck.push(card);
                } // for
            } // for

            // Add cards to Light Blue deck
            let lightBlueDeck = [];
            for ( i=0; i<config.lightBlueDeck.length; i++ ) {
                for ( j=0; j<config.lightBlueDeck[i].count; j++ ) {
                    card = config.cards.find(cards => cards.color === 'lightBlue' && cards.name === config.lightBlueDeck[i].name);
                    card.count = 1;
                    lightBlueDeck.push(card);
                } // for
            } // for

            // Add cards to Dark Blue deck
            let darkBlueDeck = [];
            for ( i=0; i<config.darkBlueDeck.length; i++ ) {
                for ( j=0; j<config.darkBlueDeck[i].count; j++ ) {
                    card = config.cards.find(cards => cards.color === 'darkBlue' && cards.name === config.darkBlueDeck[i].name);
                    card.count = 1;
                    darkBlueDeck.push(card);
                } // for
            } // for

            // Add avatars to board
            let players = [];
            for ( i=0; i<config.players.length; i++ ) {
                p = config.players[i];
                p.position = 0;
                p.ingredients = [];
                players.push(p);
            } // for

            let currentPlayer = -1;
            let cardPicksLeft = 0;
            let extraTurns = 0;
            let isSpinning = 0;

            showPlayer(0);

            // Generate a random number between first and last
            function random(first,last) { 
                return Math.floor(Math.random() * (last-first+1)) + first; 
            } // random

            // Pick a random card from the deck and remove
            function pickCard(o, deck) {
                if ( cardPicksLeft <= 0 ) {
                    alert("Next player needs to spin first");
                    return;
                } // if

                // No cards left in deck
                if ( deck.length <= 0 ) {
                    alert("No more cards left in " + o.id);
                    return;
                } // if

                // Card color must match board position
                boardColor = document.getElementById('boardTableSpace'+players[currentPlayer].position).getAttribute('boardColor');
                if ( boardColor !== deck[0].color ) {
                    alert(players[currentPlayer].name + " must pick a card from " + boardColor);
                    return;
                } // if

                // Select card from remaining deck
                i = random(1, deck.length);

                // Update shown card
                document.getElementById(o.id+'Text').innerHTML = deck[i].name;
                document.getElementById(o.id+'Card').src = deck[i].image;

                // Add card to player hand
                card = players[currentPlayer].ingredients.find(ingredients => ingredients.name === deck[i].name);
                if ( card )
                    card.count++;
                else
                    players[currentPlayer].ingredients.push(deck[i]);

                // Special cards
                if ( deck[i].extraCards )
                    cardPicksLeft += deck[i].extraCards;
                if ( deck[i].extraTurns )
                    extraTurns += deck[i].extraTurns;

                // Remove card from deck
                deck.splice(i,1);

                // Reduce available card picks for this round
                cardPicksLeft--;

                // Show player info
                showPlayer();
            } // pickCard

            function spinDone(o) {
                // Hide spinner
                isSpinning = 0;
                document.getElementById('spinnerWheel').style.display = "none";

                // Dice roll from 1 to 6
                i = random(1, 6);

                // Update spinner text
                document.getElementById(o.id+'Text').innerHTML = players[currentPlayer].name + ' spun ' + i;

                // Update player position
                players[currentPlayer].position = (players[currentPlayer].position + i ) % 18;

                console.log("Moving " + players[currentPlayer].name + " " + i + " spots to " + players[currentPlayer].position);

                // Allow player to pick cards
                cardPicksLeft = 1;

                // Show player info
                showPlayer();
            } // spinDone

            function moveNextPlayer(o) {
                if ( cardPicksLeft > 0 ) {
                    alert(players[currentPlayer].name + " still needs to pick up a card");
                    return;
                } // if

                // Reset flipped cards
                objs = document.getElementsByClassName('cardSlot');
                for ( i=0; i<objs.length; i++ ) {
                    document.getElementById(objs[i].id+'Card').src = '';
                    document.getElementById(objs[i].id+'Text').innerHTML = '';
                } // for

                // Show animation for 5 seconds
                if ( isSpinning == 0 ) {
                    isSpinning = 1;

                    // Set next player
                    if ( extraTurns > 0 )
                        extraTurns--;
                    else
                        currentPlayer = (currentPlayer+1) % players.length;

                    // Show spinner
                    document.getElementById('spinnerWheel').style.display = "";

                    // Set spinner timeout between 3s and 5s
                    window.setTimeout(function() { spinDone(o) }, random(3000,5000));

                    // Update spinner text
                    document.getElementById(o.id+'Text').innerHTML = players[currentPlayer].name + ' is spinning';
                } // if
            } // moveNextPlayer

            function showPlayer(playerId =currentPlayer) {
                // Update players on board
                objs = document.getElementsByClassName('boardTableSpace');
                for ( i=0; i<objs.length; i++ ) {
                    objs[i].innerHTML = "";
                } // for

                for (i=0; i<players.length; i++) {
                    o = document.getElementById('boardTableSpace' + players[i].position);
                    o.innerHTML += "<img class='boardTableAvatar' src='" + players[i].image + "'>";
                } // for

                // No active player yet
                if ( playerId < 0 )
                    return;

                // Update current player image
                document.getElementById('playerAvatar').src = players[playerId].image;

                let t = "<center>" + players[playerId].name + '</center><br>Ingredients:<br>';
                let points = 0;

                // List ingredients for current player
                if (players[playerId].ingredients.length > 0 ) {
                    t = t + "<ul>";
                    for (i=0; i<players[playerId].ingredients.length; i++) {
                        t = t + "<li>" + players[playerId].ingredients[i].name 
                                + (players[playerId].ingredients[i].count>1?(" (x " + players[playerId].ingredients[i].count + ")"):"") 
                                + "</li>";
                        points += players[playerId].ingredients[i].count * players[playerId].ingredients[i].points;
                    } // for
                    t = t + "</ul>";
                    t = t + "<br>Points: " + points;
                } else {
                    t = t + "no cards yets";
                } // if
                document.getElementById('playerIngredients').innerHTML = t;
            } // showPlayer
        </script>
    </body>
</html>